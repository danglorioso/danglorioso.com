---
// No server-side fetch â€” page sends full HTML immediately. Activity loads via client script.
const apiBase = Astro.url.origin;
const getColor = (count: number) => {
  if (count === 0) return '#161b22';
  if (count < 3) return '#0e4429';
  if (count < 6) return '#006d32';
  if (count < 9) return '#26a641';
  return '#39d353';
};
---
<div class="activity-section flex flex-col gap-2 p-4 sm:p-6 border border-border-primary rounded-lg" data-api-base={apiBase}>

    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-end gap-2 mb-2">
      <h2 class="text-3xl font-bold text-text-primary">Activity</h2>
      <div class="flex items-center gap-2">
        <div class="relative flex items-center justify-center">
          <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
          <div class="absolute w-2 h-2 rounded-full bg-green-500 opacity-75 animate-ping"></div>
        </div>
        <h3 id="activity-count" class="text-xm sm:text-base text-text-primary">
          <span class="text-text-secondary">Loading contributions...</span>
        </h3>
      </div>
    </div>

    <div class="bg-slate-900 rounded-md relative">
      <div id="activity-grid-container" class="weeks overflow-x-auto py-2" style="min-height: 7rem;">
        <div class="skeleton-grid">
          {Array.from({ length: 53 }).map(() => (
            <div class="week">
              {Array.from({ length: 7 }).map(() => (
                <div class="day skeleton-day" />
              ))}
            </div>
          ))}
        </div>
      </div>

      <div id="contribution-tooltip" class="tooltip hidden">
        <div id="tooltip-content"></div>
      </div>

      <div class="flex flex-col sm:flex-row flex-col-reverse sm:justify-between items-center gap-4 mt-4 mx-2">
        <div class="flex flex-row items-center justify-start sm:justify-center">
          <a
            href="https://danglorioso.com/github"
            target="_blank"
            rel="noopener noreferrer"
            class="flex items-center text-sm text-text-secondary hover:text-accent-primary transition-colors"
          >
            <div class="text-sm">View on </div>
            <svg class="w-4 h-4 ml-1 mr-0.5" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path fill-rule="evenodd" d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z" clip-rule="evenodd" />
            </svg>
            <span>GitHub</span>
          </a>
        </div>
        <div class="flex flex-end justify-end items-center text-sm gap-2">
          <span>Less</span>
          <div class="legend-colors">
            <div class="legend-box" style={`background-color: ${getColor(0)}`} />
            <div class="legend-box" style={`background-color: ${getColor(1)}`} />
            <div class="legend-box" style={`background-color: ${getColor(3)}`} />
            <div class="legend-box" style={`background-color: ${getColor(6)}`} />
            <div class="legend-box" style={`background-color: ${getColor(9)}`} />
          </div>
          <span>More</span>
        </div>
      </div>
    </div>
</div>

<style>
  .weeks { display: flex; gap: 0.25rem; }
  .week { display: flex; flex-direction: column; gap: 0.25rem; }
  .day {
    width: 0.75rem;
    height: 0.75rem;
    border-radius: 0.125rem;
    cursor: pointer;
    transition: all 0.2s;
  }
  .day:hover {
    outline: 2px solid #9ca3af;
    outline-offset: 1px;
  }
  /* Apply to dynamically inserted .day cells too */
  :global(.activity-section .day:hover) {
    outline: 2px solid #9ca3af;
    outline-offset: 1px;
  }
  .legend-colors { display: flex; gap: 0.25rem; }
  .legend-box {
    width: 0.75rem;
    height: 0.75rem;
    border-radius: 0.125rem;
  }
  .skeleton-grid { display: flex; gap: 0.25rem; }
  .skeleton-day {
    width: 0.75rem;
    height: 0.75rem;
    border-radius: 0.125rem;
    background-color: #1e293b;
    animation: skeleton-shimmer 1.5s ease-in-out infinite;
  }
  .skeleton-day:nth-child(odd) { animation-delay: 0.1s; }
  @keyframes skeleton-shimmer {
    0%, 100% { opacity: 0.6; background-color: #1e293b; }
    50% { opacity: 1; background-color: #334155; }
  }
  .tooltip {
    position: absolute;
    background-color: rgba(0, 0, 0, 0.856);
    color: white;
    padding: 0.5rem 0.75rem;
    border-radius: 0.375rem;
    font-size: 0.875rem;
    pointer-events: none;
    z-index: 1000;
    white-space: nowrap;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  }
  .tooltip.hidden { display: none; }
</style>

<script>
  interface ContributionDay {
    contributionCount: number;
    date: string;
  }
  interface ContributionWeek {
    contributionDays: ContributionDay[];
  }
  interface ContributionsData {
    totalContributions: number;
    weeks: ContributionWeek[];
  }

  const CACHE_KEY = 'activity-contributions';
  const CACHE_TIME_KEY = 'activity-contributions-time';
  const CACHE_TTL_MS = 60 * 60 * 1000; // 1 hour

  const getColor = (count: number): string => {
    if (count === 0) return '#161b22';
    if (count < 3) return '#0e4429';
    if (count < 6) return '#006d32';
    if (count < 9) return '#26a641';
    return '#39d353';
  };

  const weekStyle = 'display:flex;flex-direction:column;gap:0.25rem';
  const dayStyle = (bg: string): string => `width:0.75rem;height:0.75rem;border-radius:0.125rem;cursor:pointer;background-color:${bg}`;

  function renderGrid(
    contributions: ContributionsData,
    gridContainer: HTMLElement,
    countEl: HTMLElement
  ): void {
    if (!contributions?.weeks || !gridContainer || !countEl) return;
    countEl.innerHTML = `<span class="text-text-primary">${contributions.totalContributions.toLocaleString()} contributions in the last year</span>`;
    const weeksHtml = contributions.weeks.map((week: ContributionWeek) => `
      <div class="week" style="${weekStyle}">
        ${week.contributionDays.map((day: ContributionDay) =>
          `<div class="day" style="${dayStyle(getColor(day.contributionCount))}" data-count="${day.contributionCount}" data-date="${day.date}"></div>`
        ).join('')}
      </div>
    `).join('');
    gridContainer.innerHTML = weeksHtml;
    try { initTooltip(); } catch (_) {}
  }

  let activityClickOut: ((e: MouseEvent) => void) | null = null;

  function initTooltip(): void {
    const days = document.querySelectorAll('.day[data-count][data-date]');
    const tooltip = document.getElementById('contribution-tooltip');
    const tooltipContent = document.getElementById('tooltip-content');
    if (!tooltip || !tooltipContent) return;

    const showTooltip = (target: HTMLElement): void => {
      const count = target.getAttribute('data-count');
      const date = target.getAttribute('data-date');
      if (!count || !date) return;
      const [y, m, d] = date.split('-').map(Number);
      const formatted = new Date(y, m - 1, d).toLocaleDateString('en-US', { month: 'long', day: 'numeric' });
      tooltipContent.textContent = `${count} ${count === '1' ? 'contribution' : 'contributions'} on ${formatted}.`;
      const rect = target.getBoundingClientRect();
      const parentEl = tooltip.parentElement;
      if (!parentEl) return;
      const parent = parentEl.getBoundingClientRect();
      tooltip.style.left = `${rect.left - parent.left + rect.width / 2}px`;
      tooltip.style.top = `${rect.top - parent.top - 8}px`;
      tooltip.style.transform = 'translate(-50%, -100%)';
      tooltip.classList.remove('hidden');
    };
    const hideTooltip = (): void => tooltip.classList.add('hidden');

    if (activityClickOut) {
      document.removeEventListener('click', activityClickOut);
    }
    activityClickOut = (e: MouseEvent) => {
      if (!(e.target as HTMLElement).closest('.day')) hideTooltip();
    };
    document.addEventListener('click', activityClickOut);

    days.forEach((day) => {
      day.addEventListener('mouseenter', (e) => showTooltip(e.target as HTMLElement));
      day.addEventListener('mouseleave', hideTooltip);
      day.addEventListener('click', (e) => showTooltip(e.target as HTMLElement));
    });
  }

  async function loadContributions() {
    const gridContainer = document.getElementById('activity-grid-container');
    const countEl = document.getElementById('activity-count');
    if (!gridContainer || !countEl) return;

    const wrapper = document.querySelector('[data-api-base]');
    const base = wrapper?.getAttribute('data-api-base') || window.location.origin;
    const apiUrl = `${base}/api/github-contributions`;

    // Use cache if fresh
    try {
      const cached = localStorage.getItem(CACHE_KEY);
      const cachedTime = localStorage.getItem(CACHE_TIME_KEY);
      if (cached && cachedTime && Date.now() - Number(cachedTime) < CACHE_TTL_MS) {
        const data = JSON.parse(cached);
        if (data?.weeks) {
          renderGrid(data, gridContainer, countEl);
          return;
        }
      }
    } catch (_) {}

    try {
      const res = await fetch(apiUrl);
      const data = await res.json();
      if (!res.ok || data.error) {
        countEl.innerHTML = '<span class="text-red-400">Failed to load contributions</span>';
        gridContainer.innerHTML = '<div class="py-8 text-center text-gray-400"><p>Unable to load. Please refresh.</p></div>';
        return;
      }
      if (data?.weeks) {
        try {
          localStorage.setItem(CACHE_KEY, JSON.stringify(data));
          localStorage.setItem(CACHE_TIME_KEY, String(Date.now()));
        } catch (_) {}
        renderGrid(data, gridContainer, countEl);
      }
    } catch (e) {
      countEl.innerHTML = '<span class="text-red-400">Failed to load contributions</span>';
      gridContainer.innerHTML = '<div class="py-8 text-center text-gray-400"><p>Unable to load. Please refresh.</p></div>';
    }
  }

  function init() {
    loadContributions();
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
  document.addEventListener('astro:page-load', init);
</script>
